using System;
using System.Collections.Generic;
using System.Text;
using System.Threading.Tasks;
using System.Diagnostics;
using System.Threading;
using System.Timers;

namespace ConsoleApplication1
{
    class Program
    {   //single threaded console gameloop design, with tests - mrGrak 2019
        public static int actorCount = 256;
        public static int testsCount = 10;

        public class Actor
        {
            public float x, y = 0;
            public Boolean active = false;
        }
        public static class Pool //build the lists that model actors
        {
            public static List<Actor> Actors = new List<Actor>();
            static Pool() //setup the pools to handle size amount of actors
            { for (int i = 0; i < actorCount; i++) { Actors.Add(new Actor()); } }
        }

        public static class Simulation
        {
            static int i, a;
            public static int GoalPosition_X = actorCount; //top right of game grid
            public static int GoalPosition_Y = 0; //actors move towards goal pos x,y
            public static int activeActors = actorCount; //setup active counter
            public static Stopwatch timer = new Stopwatch();

            public static long ticks_total = 0;
            public static double tick_avg = 0;

            public static long ms_total = 0;
            public static double ms_avg = 0;

            public static double frames_total = 0;

            public static void Setup()
            {
                for (i = 0; i < actorCount; i++)
                {   //set active, position actors from 0,0 down-right
                    Pool.Actors[i].active = true;
                    Pool.Actors[i].x = i; //position diagonally right and
                    Pool.Actors[i].y = i; //down, with some space between
                }
                activeActors = actorCount; //set actor counter
                frames_total = 0; //reset frames total
            }

            public static void Run()
            {
                Setup(); //ensure sim is ready
                timer.Restart();
                while (activeActors > 1) //one or less actor ends sim
                {
                    frames_total++; //count this as a frame of work
                    for (i = 0; i < actorCount; i++) //main work loop
                    {
                        if (Pool.Actors[i].active) //only process active actors
                        {
                            //step 1 - move actors
                            //move towards x goal position
                            if (Pool.Actors[i].x < GoalPosition_X)
                            { Pool.Actors[i].x += 0.5f; }
                            else { Pool.Actors[i].x -= 0.5f; }
                            //move towards y goal position
                            if (Pool.Actors[i].y < GoalPosition_Y)
                            { Pool.Actors[i].y += 0.5f; }
                            else { Pool.Actors[i].y -= 0.5f; }

                            //step 2 - check collisions, handle active status
                            for (a = 0; a < actorCount; a++) //loop all actors,
                            {   //remove any overlapping active actors from main loop
                                if (Pool.Actors[a].active) //only check overlaps vs actives
                                {
                                    if (i != a) //dont check actor against self
                                    {
                                        if ( //actor must match x, y pos to be overlapping
                                            (Pool.Actors[a].x == Pool.Actors[i].x)
                                            &&
                                            (Pool.Actors[a].y == Pool.Actors[i].y)
                                            )
                                        {   //actor i is removed from main loop
                                            Pool.Actors[i].active = false;
                                            activeActors--;
                                            a = actorCount; //stop actor[i]'s collision chex
                                        }
                                    }
                                }
                            } //actor work complete
                        }
                    }
                }
                timer.Stop();
                ticks_total = timer.ElapsedTicks;
                ms_total = timer.ElapsedMilliseconds;
                tick_avg = (ticks_total / frames_total);
                ms_avg = (ms_total / frames_total);
            }
        }

        static void Main(string[] args)
        {
            int g;
            Stopwatch mainTimer = new Stopwatch();

            long ticks_total = 0;
            double tick_avg = 0;
            long ms_total = 0;
            double ms_avg = 0;
            double sims_total = 0;

            mainTimer.Restart();
            for (g = 0; g < testsCount; g++)
            {
                Simulation.Run();
                sims_total++;
            }
            mainTimer.Stop();

            ticks_total = mainTimer.ElapsedTicks;
            ms_total = mainTimer.ElapsedMilliseconds;
            tick_avg = (ticks_total / sims_total);
            ms_avg = (ms_total / sims_total);

            Console.WriteLine(
                "--- sims complete ----\n"
                + "total sims " + sims_total
                + "\ntotal ms " + ms_total
                + " total tix " + ticks_total
                + "\navg ms " + ms_avg
                + " avg tix " + tick_avg
                );
            Console.Read();
        }
    }
}